# HakoNyans Phase 7+ 作戦書：速度×画質の両立 🐱⚡

**作成日**: 2026-02-10
**現状**: Phase 6 完了、JPEG-XL/AVIF より速いが、ファイルサイズが JPEG の 6倍

---

## 📊 現状の問題

| 指標 | HakoNyans (Q=75) | JPEG (Q=90) | 差 |
|------|-------------------|-------------|-----|
| デコード速度 | 27.4 ms | 8.3 ms | 3.3x 遅い |
| ファイルサイズ | 1004 KB | 168 KB | **6.0x 大きい** ← 主問題 |
| PSNR | 41.3 dB | 34.6 dB | 6.7 dB 良い |

**分析**: 画質は高いが、ファイルサイズが大きすぎる。同じ PSNR なら HakoNyans の方がずっと大きい。
**原因**: 4:2:0 なし、予測なし、適応量子化なし、CDF が画像全体で1つ

---

## 🎯 目標

**Phase 7 完了時に達成したい数値**:
- ファイルサイズ: JPEG の **2x 以内**（現在 6x）
- デコード速度: **20ms 以下** @ Full HD（現在 27.4ms）
- PSNR: JPEG と同等以上（同サイズ比較で）

**Phase 8 完了時（最終目標）**:
- ファイルサイズ: JPEG と同等 or やや小さい
- デコード速度: JPEG と同等 or やや速い
- ロスレスモード対応

---

## 🔬 ChatGPT Pro 3案の分析

### A案: CfL（Chroma from Luma）— ⭐ 最優先

**概要**: クロマをルマの線形関数で予測、残差だけ送る
```
Cb_pred[x,y] = alpha_cb * Y[x,y] + beta_cb
Cb_residual = Cb_actual - Cb_pred
→ Cb_residual をエンコード（情報量が大幅に減る）
```

**HakoNyans との相性**: ⭐⭐⭐⭐⭐
- ✅ デコーダ負荷: 超軽い（乗算+加算のみ）
- ✅ 圧縮効率: クロマ残差の分布が尖る → rANS に最適
- ✅ 並列化: ブロック単位で独立計算可能
- ✅ 実装難度: 低（ブロック単位の線形回帰）
- **期待効果**: クロマサイズ -15〜25%

**実装方針**:
- エンコーダ: ブロックごとに alpha, beta を最小二乗法で計算
- デコーダ: alpha, beta を読み取り、Y から Cb/Cr を予測、残差を加算
- alpha, beta はブロックまたはタイル単位でシグナリング

### B案: Super-res + 軽量 Restore — ⚠️ Phase 8 向き

**概要**: 低解像度でエンコード→規定アップスケール→復元フィルタ

**HakoNyans との相性**: ⭐⭐⭐
- ✅ 圧縮効率: 大幅改善可能（解像度が半分なら情報量は1/4）
- ❌ デコーダ負荷: アップスケール+復元が追加される
- ⚠️ 実装複雑度: 高（アップスケーラ、復元フィルタの設計）
- ⚠️ 品質リスク: アップスケールで細部が失われる

**判断**: Phase 8 以降で「低ビットレートプロファイル」として追加。Phase 7 では見送り。

### C案: Film Grain Synthesis — ⚠️ Phase 8 向き

**概要**: 粒状ノイズを除去してエンコード、デコード後に合成

**HakoNyans との相性**: ⭐⭐⭐
- ✅ デコーダ負荷: 軽い（ノイズ生成は高速）
- ✅ 圧縮効率: ノイズ除去で大幅改善
- ❌ 写真限定（線画/スクショには不向き）
- ⚠️ エンコーダ側が複雑（ノイズ推定が必要）

**判断**: Phase 8 で「写真プロファイル」のオプションとして追加。

---

## 💡 Claude 追加提案（4案）

### D案: 適応量子化（Activity Masking）— ⭐ 最優先

**概要**: テクスチャが複雑な場所は荒く、平坦な場所は丁寧に量子化

```
activity = Σ|AC_coefficients|  (ブロックの"忙しさ")
q_scale = base_q * (activity / avg_activity)^mask_strength
→ 忙しいブロックは荒く（目立たない）
→ 静かなブロックは丁寧に（目立つ）
```

**HakoNyans との相性**: ⭐⭐⭐⭐⭐
- ✅ **デコーダ負荷: ゼロ**（量子化テーブルが変わるだけ）
- ✅ 圧縮効率: 同じ PSNR で -10〜15% ファイルサイズ
- ✅ 主観品質: 大幅改善（知覚に合った壊れ方）
- ✅ 実装: エンコーダのみ変更、デコーダは同じ
- **期待効果**: 同じファイルサイズで PSNR +1〜2dB、または同 PSNR で -10〜15%

**実装方針**:
- エンコーダ: ブロックごとに activity 計算 → q_scale 決定
- 量子化テーブル: ブロック単位 or タイル単位で可変
- シグナリング: q_delta をストリームに書く（小さいオーバーヘッド）
- デコーダ: q_delta 読み取り → dequant テーブル調整（既存コードの延長）

### E案: 4:2:0 サブサンプリング — ⭐ 最重要（ファイルサイズ）

**概要**: クロマの解像度を半分にする（JPEG と同じ）

**期待効果**: **ファイルサイズ -33%**（クロマ 2チャンネル × 1/4 = 全体の1/3削減）

```
現在 (4:4:4): Y(1920×1080) + Cb(1920×1080) + Cr(1920×1080)
改善 (4:2:0): Y(1920×1080) + Cb(960×540) + Cr(960×540)
→ 1004KB × 0.67 ≈ 673 KB
```

**HakoNyans との相性**: ⭐⭐⭐⭐
- ✅ 圧縮効率: 最大のインパクト（-33% は確実）
- ✅ 実装: エンコーダでダウンサンプル、デコーダでアップサンプル
- ⚠️ デコーダ負荷: アップサンプルが追加（ただし軽い）
- ⚠️ 品質: 色境界ににじみが出る（CfL と組み合わせて緩和）

**実装方針**:
- エンコーダ: Cb/Cr を 2×2 平均でダウンサンプル
- デコーダ: バイリニア or 近傍アップサンプル
- FileHeader: subsampling フィールド (0=4:4:4, 1=4:2:0)

### F案: Band-group 別 CDF — ⭐ 効果的

**概要**: AC係数を周波数帯域で分けて、別々の CDF でエンコード

```
現在: 全64位置の AC を1つの CDF でエンコード
改善: Low-band (zigzag 0-15), Mid-band (16-31), High-band (32-62)
→ 各バンドの分布が異なるため、CDF が尖って rANS 効率が上がる
```

**HakoNyans との相性**: ⭐⭐⭐⭐
- ✅ 圧縮効率: -5〜10%（特に高周波帯域）
- ✅ デコーダ負荷: ほぼ変わらない（CDF テーブル切り替えのみ）
- ⚠️ 実装: トークン化とストリーム分割の変更が必要
- ⚠️ CDF オーバーヘッド: バンド数 × 308B（3バンドで +616B）

### G案: AAN IDCT 高速化 — ⭐ デコード速度向上

**概要**: 現在の float DCT/IDCT を整数 AAN アルゴリズムに置き換え

```
現在: float cos() ベース（ナイーブ、遅い）
改善: AAN (Arai-Agui-Nakajima) → 乗算5回、加算29回で 1D-IDCT
→ さらに量子化テーブルに AAN スケール係数を事前統合
```

**期待効果**: IDCT が 2-3x 速くなる → 全体デコード速度 +20-30%

**HakoNyans との相性**: ⭐⭐⭐⭐⭐
- ✅ デコーダ速度: 最大のインパクト
- ✅ 品質: bit-exact（正しく実装すれば同一結果）
- ✅ SIMD 化しやすい（固定構造、分岐なし）
- ✅ 実装: transform_dct.h の差し替えのみ

---

## 🏗️ ロスレスモード設計

### 必要な変更

1. **可逆色変換**: YCoCg-R（リフティングベース、完全可逆）
   ```
   Co = R - B
   tmp = B + (Co >> 1)
   Cg = G - tmp
   Y = tmp + (Cg >> 1)
   ```

2. **量子化なし**: Q=lossless フラグ → dequant をスキップ

3. **予測**: Paeth predictor（PNG と同じ、左/上/左上から最良を選択）
   ```
   pred = paeth(left, above, above_left)
   residual = pixel - pred
   → residual をトークン化→rANS
   ```

4. **DCT バイパス**: ロスレスでは DCT を使わず、予測残差を直接エンコード

### ロスレス パイプライン

```
[入力 RGB]
  → YCoCg-R (可逆色変換)
  → Paeth 予測 (残差生成)
  → トークン化 (MAGC+REM)
  → NyANS-P (rANS エンコード)
  → .hkn ファイル
```

### ロスレス vs ロッシー の切り替え

```
FileHeader.flags:
  bit 0: 0=lossy, 1=lossless
  bit 1: 0=4:4:4, 1=4:2:0  (lossy only)
  bit 2: 0=no CfL, 1=CfL    (lossy only)
```

---

## 📋 実装ロードマップ

### Phase 7a: 圧縮率改善（ファイルサイズ 6x → 2x）

| 順番 | 施策 | 期待効果 | デコーダ影響 | 難度 |
|------|------|---------|------------|------|
| ① | **4:2:0 サブサンプリング** (E案) | **-33%** | 軽い追加 | ★★ |
| ② | **適応量子化** (D案) | **-10〜15%** | **なし** | ★★ |
| ③ | **CfL** (A案) | **-15〜25% (クロマ)** | 超軽い | ★★★ |
| ④ | **Band-group CDF** (F案) | **-5〜10%** | ほぼなし | ★★ |

**累積効果予想**:
```
Phase 6 時点:  1004 KB (6.0x vs JPEG)
① 4:2:0:       673 KB (4.0x)
② 適応量子化:  572 KB (3.4x)
③ CfL:         486 KB (2.9x)
④ Band CDF:    462 KB (2.7x)
→ 目標「2x 以内」まであと一歩
```

### Phase 7b: デコード速度改善（27ms → 15ms）

| 順番 | 施策 | 期待効果 | 実装影響 | 難度 |
|------|------|---------|---------|------|
| ① | **AAN IDCT** (G案) | **IDCT 2-3x速** | dct.h 差替 | ★★★ |
| ② | **SIMD 色変換** | **+10% 全体** | colorspace.h | ★★ |
| ③ | **メモリレイアウト最適化** | **+10% 全体** | encode/decode | ★★ |

**累積効果予想**:
```
Phase 6 時点:  27.4 ms
① AAN IDCT:    ~20 ms
② SIMD色変換:  ~18 ms
③ メモリ最適化: ~15 ms
→ 目標「20ms 以下」達成見込み
```

### Phase 8: ロスレス + 高度機能

| 施策 | 内容 | 難度 |
|------|------|------|
| ロスレスモード | YCoCg-R + Paeth + rANS（DCT バイパス）| ★★★★ |
| Super-res (B案) | 低ビットレート向けプロファイル | ★★★★★ |
| Film Grain (C案) | 写真向けオプション | ★★★ |
| 軽量デブロッキング | normative 1段 EPF | ★★★★ |
| プログレッシブ | DC→Low AC→High AC の3段階 | ★★★ |

---

## 🔑 設計原則（全 Phase 共通）

### 1. デコーダを軽く保つ
```
エンコーダで頑張る → デコーダは固定処理だけ
RDO、適応量子化、CfL のパラメータ選択 → 全てエンコーダ側
デコーダはパラメータを読んで適用するだけ
```

### 2. 並列化を壊さない
```
ブロック間依存を作らない（DC DPCM はチャンク内のみ）
CfL: 同一ブロック内で完結（隣接ブロック不要）
適応量子化: ブロック独立（q_delta を読むだけ）
```

### 3. 拡張可能に保つ
```
FileHeader.flags で機能を ON/OFF
未知のチャンクは skip
プロファイル（lossy-fast / lossy-quality / lossless）で分岐
```

### 4. 既存テストを壊さない
```
Phase 5 のグレースケール・カラーテストは全て PASS を維持
新機能は新テストで検証
互換性: flags=0 なら Phase 6 と同じ動作
```

---

## 📊 最終目標サマリ

### Phase 7 完了後（予想値 vs 競合）

| Codec | サイズ | PSNR | デコード | 強み |
|-------|--------|------|---------|------|
| **HakoNyans** | **~460 KB** | **~38 dB** | **~15 ms** | **速度×並列** |
| JPEG | ~168 KB | ~34.6 dB | ~8 ms | 互換性 |
| JPEG-XL | ~96 KB | ~36.9 dB | ~34 ms | 圧縮率 |
| AVIF | ~80 KB | ~37.5 dB | ~150 ms | 高画質 |

**ポジショニング**:
- JPEG より高画質で、JPEG-XL より速い → **「速い高画質」のニッチ**
- 圧縮率は JPEG の 2.7x 程度 → まだ改善余地あり
- 4K/8K ではマルチコアが効いて JPEG を逆転する可能性

### Phase 8 完了後（最終形態）

| 機能 | 対応 |
|------|------|
| ロッシー（写真） | ✅ CfL + 適応量子化 + 4:2:0 |
| ロッシー（高速） | ✅ 4:4:4 固定 Q（現在と同じ） |
| ロスレス | ✅ YCoCg-R + Paeth + rANS |
| 低ビットレート | ✅ Super-res + Restore（オプション） |
| 写真品質 | ✅ Film Grain（オプション） |

---

**次のアクション**: Phase 7a の ① 4:2:0 → ② 適応量子化 → ③ CfL → ④ Band CDF の順で実装開始にゃ！🚀
