# Phase 9w Log (2026-02-14)

## Scope
- Continue single-core-first optimization after Step2 (`lossless_mode_select.h` LUT) promotion.
- Gate:
  - `total HKN bytes <= 2,977,544`
  - `median PNG/HKN >= 0.2610`
  - `ctest` 17/17 PASS
  - fixed6, `HAKONYANS_THREADS=1`, `taskset -c 0`, `runs=3`, `warmup=1`

## Baseline
- `bench_results/phase9w_singlecore_blockclass_step2_scalar_final_vs_afterfix_20260214_runs3.csv`
- key median:
  - `Enc(ms) 176.646`
  - `plane_route_comp(ms) 59.212`
  - `plane_lo_stream(ms) 58.312`

## Trial A: lo_stream mode3 branch-reduction rewrite (no-go)
- CSV:
  - `bench_results/phase9w_singlecore_lostream_mode3_branchcut_vs_step2_20260214_runs3.csv`
- result:
  - `Enc(ms) 176.646 -> 183.268` (regression)
  - size/ratio invariants unchanged
- archive:
  - `docs/archive/2026-02-14_lostream_mode3_branchcut_nogo.md`

## Trial B: byte_stream_encoder alloc/copy reduction (no-go)
- CSV:
  - `bench_results/phase9w_singlecore_bstream_allocopt_vs_step2_20260214_runs3.csv`
  - `bench_results/phase9w_singlecore_bstream_allocopt_vs_step2_20260214_runs3_rerun.csv`
- result:
  - wall encode not stable; no clear win across reruns
  - size/ratio invariants unchanged
- archive:
  - `docs/archive/2026-02-14_bstream_allocopt_nogo.md`

## Trial C: route_natural cost-loop fast-abs (no-go)
- CSV:
  - `bench_results/phase9w_singlecore_routecost_fastabs_vs_step2_20260214_runs3.csv`
- result:
  - `Enc(ms) 176.646 -> 187.400` (regression)
  - size/ratio invariants unchanged
- archive:
  - `docs/archive/2026-02-14_routecost_fastabs_nogo.md`

## Decision
- Reverted three no-go trial patches (A/B/C).
- Kept Trial D (`TileLZ::compress` low-level optimization) as current candidate.
- Preserved no-go history in `docs/archive/`.

## Trial D: TileLZ::compress low-level optimization (kept candidate)
- Target:
  - `src/codec/lz_tile.h`
- Changes:
  - hash-head initialization: per-call full init -> thread_local epoch table
  - literal flush: `insert(...)` -> `resize + memcpy`
  - match write: `push_back` chain -> contiguous fixed-size write
- Validation:
  - build + `ctest` 17/17 PASS
- CSV:
  - single-core:
    - `bench_results/phase9w_singlecore_tilelz_compress_fast_vs_step2_20260214_runs3.csv`
    - `bench_results/phase9w_singlecore_tilelz_compress_fast_vs_step2_20260214_runs3_rerun.csv`
    - `bench_results/phase9w_singlecore_tilelz_compress_fast_vs_step2_20260214_runs3_rerun2.csv`
    - `bench_results/phase9w_singlecore_tilelz_compress_fast_vs_step2_20260214_runs3_rerun3.csv`
  - multicore:
    - `bench_results/phase9w_tilelz_compress_fast_vs_step2_multi_20260214_runs3.csv`
    - `bench_results/phase9w_tilelz_compress_fast_vs_step2_multi_20260214_runs3_rerun.csv`
- Summary:
  - size invariants unchanged (`total=2,977,544`, `median PNG/HKN=0.261035`)
  - single-core `Enc(ms)`:
    - run1: `177.719` (regression)
    - run2: `174.960` (improvement)
    - run3: `175.056` (improvement)
    - run4: `175.765` (improvement)
  - decision: keep candidate (small but repeatable net gain)

## Trial E: `filter_lo` mode3/4 safe lower-bound skip + encode mode adoption counters (kept)
- Target:
  - `src/codec/lossless_filter_lo_codec.h`
  - `bench/bench_png_compare.cpp`
- Changes:
  - Added safe lower-bound reject for `mode3` and `mode4` in `encode_filter_lo_stream`.
    - reject when theoretical minimum wrapper size cannot beat `best_size`
    - reject when minimum size cannot pass wrapper gate (`990 permille`)
  - Added encode-side `filter_lo` mode adoption counters (`mode0..5`) to fixed6 CSV.
- Validation:
  - build + `ctest` 17/17 PASS
  - fixed6 single-core observation:
    - `bench_results/phase9w_singlecore_lostream_lbcut_obs_20260214_runs3.csv`
  - size gate:
    - `total HKN bytes = 2,977,544` (unchanged)
    - `median PNG/HKN = 0.2610` (unchanged)
- Mode adoption (per-image median, 3 planes):
  - `kodim01`: `mode5=3`
  - `kodim02`: `mode2=1`, `mode5=2`
  - `kodim03`: `mode0=1`, `mode1=2`
  - `hd_01`: `mode3=1`, `mode4=2`
  - `nature_01`: `mode0=2`, `mode4=1`
  - `nature_02`: `mode0=3`
- Decision:
  - keep lower-bound skip and CSV extension.
  - no static mode disable yet; each mode still appears in fixed6 adoption.

## Trial F: `route_natural mode2` nice-length cutoff
- Target:
  - `src/codec/lossless_natural_route.h`
  - `src/codec/lossless_mode_debug_stats.h`
  - `bench/bench_png_compare.cpp`
- Changes:
  - added `GlobalChainLzParams::nice_length` with env parser:
    - `HKN_LZ_NICE_LENGTH` (`4..255`)
  - added chain-loop early break when `best_len >= nice_length`
    (existing `best_len==255` break remains unchanged)
  - added telemetry:
    - `natural_row_mode2_lz_nice_cutoff_hits`
    - CSV: `hkn_enc_route_nat_mode2_lz_nice_cutoff_hits`

### Trial F-1: default `nice_length=64` (No-Go)
- CSV:
  - `bench_results/phase9w_singlecore_mode2_nice64_vs_lostreamlb_20260214_runs3.csv`
- Result:
  - size gate failed:
    - `kodim01`: `+6,907 B`
    - `hd_01`: `+237 B`
    - fixed6 total: `+7,144 B`
  - stage counters improved on hot path:
    - `chain_steps`: `3,530,143 -> 3,354,758`
    - `nice_cutoff_hits`: `5,044`
  - but non-worsening size rule is violated.
- archive:
  - `docs/archive/2026-02-14_mode2_nice64_nogo.md`

### Trial F-2: keep infra, set default `nice_length=255` (Kept)
- CSV:
  - `bench_results/phase9w_singlecore_mode2_nice255_vs_lostreamlb_20260214_runs3.csv`
- Result:
  - size gate restored:
    - `total HKN bytes = 2,977,544` (unchanged)
    - `median PNG/HKN = 0.2610` (unchanged)
  - `nice_cutoff_hits = 0` by default, so behavior is baseline-equivalent
    unless env override is used.
- Decision:
  - keep `nice_length` infrastructure + counters.
  - keep default at `255` for safety.
  - continue tuning via explicit env sweep only.

## Trial G: bind `nice_length` override to `fast` lane (Kept)
- Target:
  - `src/codec/encode.h`
  - `src/codec/lossless_natural_route.h`
- Changes:
  - `LosslessPresetPlan` now carries
    `natural_route_mode2_nice_length_override`.
  - `fast` preset sets this override from env:
    - `HKN_FAST_LZ_NICE_LENGTH` (default `64`, range `4..255`)
  - `balanced/max` keep `-1` (use global runtime default/path).
  - Natural route entry points now accept optional
    `mode2_nice_length_override` and apply it per encode call.
- Validation:
  - build + `ctest` 17/17 PASS
  - smoke:
    - `bench_results/phase9w_fast_lane_nice_binding_smoke_20260214_runs1.csv`
- Notes:
  - current policy keeps `fast` lane route competition OFF, so natural route
    is not entered in default `fast` operation (`nat_mode2_lz* == 0`).
  - binding is in place for lane coupling consistency and future opt-in
    fast-route experiments.

## Trial H: `mode2 nice_length` high-range sweep (`128..255`) (No-Go except `255`)
- Scope:
  - evaluate whether higher `nice_length` values can keep size gate while
    reducing mode2 chain-search cost.
- Fixed condition:
  - `HAKONYANS_THREADS=1`
  - `taskset -c 0`
  - fixed6, `runs=3`, `warmup=1`
  - baseline:
    `bench_results/phase9w_singlecore_lostream_lbcut_obs_20260214_runs3.csv`
- CSV:
  - `bench_results/phase9w_singlecore_mode2_nice128_vs_lostreamlb_20260214_runs3.csv`
  - `bench_results/phase9w_singlecore_mode2_nice160_vs_lostreamlb_20260214_runs3.csv`
  - `bench_results/phase9w_singlecore_mode2_nice192_vs_lostreamlb_20260214_runs3.csv`
  - `bench_results/phase9w_singlecore_mode2_nice224_vs_lostreamlb_20260214_runs3.csv`
  - `bench_results/phase9w_singlecore_mode2_nice255_vs_lostreamlb_20260214_runs3.csv`

### Result table (fixed6 aggregate)
| nice_length | total HKN bytes | median PNG/HKN | median Enc(ms) | chain_steps (sum) | nice_hits (sum) | gate |
|---:|---:|---:|---:|---:|---:|---|
| 128 | 2,982,626 | 0.2610 | 175.353 | 29,077,809 | 10,952 | FAIL |
| 160 | 2,981,251 | 0.2610 | 173.219 | 29,146,907 | 7,764 | FAIL |
| 192 | 2,980,211 | 0.2610 | 173.024 | 29,192,294 | 5,700 | FAIL |
| 224 | 2,979,009 | 0.2610 | 173.093 | 29,224,838 | 4,169 | FAIL |
| 255 | 2,977,544 | 0.2610 | 172.720 | 29,242,731 | 0 | PASS |

### Decision
- `nice_length < 255` is **No-Go** under balanced lane size rules.
- Keep `nice_length=255` as default baseline.
- Keep `nice_length` infra/counters for:
  - fast-lane experiments
  - diagnostic runs
- Next optimization target moves to bit-identical loop-cost reduction
  inside mode2 (`match_len`/candidate-check path), not cutoff tuning.

### Archive
- `docs/archive/2026-02-14_mode2_nice_sweep_128_224_nogo.md`

## Trial I: fast lane organization (`fast` default + `fast_nat` env opt-in)
- Objective:
  - keep `fast` as pure throughput lane by default
  - provide explicit opt-in path to test natural-route cost/benefit in fast lane
    without adding a new preset enum.
- Target:
  - `src/codec/encode.h`
  - `docs/PHASE9W_SPEED_SIZE_BALANCE_POLICY.md`
  - `current_task.md`
- Implementation:
  - added fast-lane env gates:
    - `HKN_FAST_ROUTE_COMPETE` (default `0`)
    - `HKN_FAST_ROUTE_COMPETE_CHROMA` (default `0`)
    - `HKN_FAST_ROUTE_COMPETE_CHROMA_CONSERVATIVE` (default `1`)
  - `HKN_FAST_LZ_NICE_LENGTH` is now applied only when
    `HKN_FAST_ROUTE_COMPETE=1`.
  - default `--preset fast` behavior stays route-competition OFF
    (bitstream behavior unchanged from previous fast default).

### Validation
- Build: `cmake --build build -j8`
- Tests: `ctest --test-dir build --output-on-failure`
- Result: `17/17 PASS`

### Smoke Bench (fixed6, single-core, runs=1)
- `bench_results/phase9w_fast_lane_org_fast_default_20260214_runs1.csv`
- `bench_results/phase9w_fast_lane_org_fast_nat_luma_20260214_runs1.csv`

Summary:
- fast default:
  - total bytes: `3,043,572`
  - median PNG/HKN: `0.2610`
  - median Enc(ms): `121.567`
  - natural selected/candidates: `0/0`
- fast_nat opt-in (`HKN_FAST_ROUTE_COMPETE=1`, luma only):
  - total bytes: `3,043,572`
  - median PNG/HKN: `0.2610`
  - median Enc(ms): `165.921`
  - natural selected/candidates: `0/4`

Decision:
- Keep this as lane organization/scaffolding.
- `fast_nat` is currently diagnostic-only (no size gain in smoke, large encode
  overhead). Use only for targeted fast-lane A/B sweeps.

## Trial J: `max` lane mode2 strategy switch (`greedy` vs `lazy1`)
- Objective:
  - add lane-switchable mode2 LZ strategy while preserving format compatibility.
  - keep `balanced` behavior untouched; route strategy experiments go to `max`.
- Target:
  - `src/codec/lossless_natural_route.h`
  - `src/codec/encode.h`
- Implementation:
  - Added `GlobalChainLzParams::match_strategy`:
    - `0=greedy` (existing behavior)
    - `1=lazy1` (one-byte lookahead deferral)
  - Added runtime env:
    - `HKN_LZ_MATCH_STRATEGY` (`0..1`, default `0`)
  - Added per-call override plumbing from preset plan:
    - `natural_route_mode2_match_strategy_override`
  - Added lane envs:
    - `HKN_FAST_LZ_MATCH_STRATEGY` (default `0`)
    - `HKN_MAX_LZ_MATCH_STRATEGY` (default `1`)
  - Preset policy:
    - `balanced`: no override (`-1`), preserves existing runtime behavior
    - `fast`: override only when fast route competition is opt-in
    - `max`: default override to `lazy1`

### Validation
- Build: `cmake --build build -j8`
- Tests: `ctest --test-dir build --output-on-failure`
- Result: `17/17 PASS`

### Smoke Bench (fixed6, single-core, runs=1)
- greedy:
  - `bench_results/phase9w_max_lane_match_strategy0_smoke_20260214_runs1.csv`
- lazy1:
  - `bench_results/phase9w_max_lane_match_strategy1_smoke_20260214_runs1.csv`

Summary:
- `greedy` (`HKN_MAX_LZ_MATCH_STRATEGY=0`)
  - total bytes: `2,977,544`
  - median PNG/HKN: `0.2610`
  - median Enc(ms): `198.207`
  - median `nat_mode2(ms)`: `33.534`
  - mode2 chain steps (sum): `33,202,766`
- `lazy1` (`HKN_MAX_LZ_MATCH_STRATEGY=1`)
  - total bytes: `2,977,040` (`-504 B` vs greedy smoke)
  - median PNG/HKN: `0.2610`
  - median Enc(ms): `234.420` (`+36.213 ms`)
  - median `nat_mode2(ms)`: `67.424` (slower)
  - mode2 chain steps (sum): `80,435,778`

Decision:
- Keep strategy-switch infra.
- Keep `lazy1` as **max-lane compression-first** default only.
- Do not promote `lazy1` to `balanced`/`fast` paths.

## Trial K: `max` lane mode2 `optparse_dp` (strategy=2)
- Objective:
  - introduce DP-based optimal parsing for mode2 in max lane only.
  - keep token format unchanged and preserve lossless/decoder compatibility.
- Target:
  - `src/codec/lossless_natural_route.h`
  - `src/codec/encode.h`
  - `src/codec/lossless_mode_debug_stats.h`
  - `docs/PHASE9W_SPEED_SIZE_BALANCE_POLICY.md`
  - `current_task.md`
- Implementation:
  - Extended strategy range:
    - runtime `HKN_LZ_MATCH_STRATEGY`: `0..2`
    - max-lane override `HKN_MAX_LZ_MATCH_STRATEGY`: `0..2` (default stays `1`)
  - Added `mode2` DP parser (`strategy=2`):
    - DAG DP over source position
    - token grammar unchanged:
      - litrun: `[0][len][bytes...]`
      - match: `[1][len][dist_lo][dist_hi]`
    - deterministic tie-break in equal-cost transitions
  - Added guarded fallback:
    - memcap / alloc failure / unreachable parse -> fallback to existing mode2 path
  - Added DP telemetry counters to mode2 LZ stats.

### Validation
- Build: `cmake --build build -j8`
- Tests: `ctest --test-dir build --output-on-failure`
- Result: `17/17 PASS`

### Fixed6 Bench (single-core, runs=3, warmup=1)
- K-1 baseline (`strategy=1`, lazy1):
  - `bench_results/phase9w_max_lane_match_strategy1_vs_optparse_20260214_runs3.csv`
- K-1 candidate (`strategy=2`, optparse_dp always-on):
  - `bench_results/phase9w_max_lane_match_strategy2_optparse_20260214_runs3.csv`

Summary:
- K-1 `strategy=1`:
  - total HKN bytes: `2,977,040`
  - median PNG/HKN: `0.2610`
  - median Enc(ms): `229.730`
  - median `nat_mode2(ms)`: `67.765`
- K-1 `strategy=2`:
  - total HKN bytes: `2,975,045` (`-1,995 B`)
  - median PNG/HKN: `0.2610`
  - median Enc(ms): `496.291` (`+266.561 ms`, `2.16x` slower)
  - median `nat_mode2(ms)`: `308.943` (`+241.178 ms`)
  - A/B diff confirms size gain is concentrated on `kodim01` (`-1,995 B`).

### K-2: conditional DP activation gate (kept)
- Objective:
  - avoid always-on DP cost by running DP only for streams likely to benefit.
- Added gate (strategy=2 path):
  - run `lazy1` pre-pass first.
  - evaluate pre-indicators:
    - `src_bytes <= HKN_LZ_OPTPARSE_PROBE_SRC_MAX` (default `2MiB`)
    - `lazy_out/src` ratio in
      `[HKN_LZ_OPTPARSE_PROBE_RATIO_MIN, HKN_LZ_OPTPARSE_PROBE_RATIO_MAX]`
      (default `20..120` per-mille).
  - only gated-pass streams execute DP.
  - adopt DP output only when gain is meaningful:
    - `dp_out + HKN_LZ_OPTPARSE_MIN_GAIN_BYTES <= lazy_out`
    - default min gain: `256 B`
- New CSV:
  - baseline (`strategy=1`): `bench_results/phase9w_max_lane_match_strategy1_after_dp_gate_20260214_runs3.csv`
  - candidate (`strategy=2`): `bench_results/phase9w_max_lane_match_strategy2_dp_gate_final_20260214_runs3.csv`

K-2 summary:
- `strategy=1`:
  - total HKN bytes: `2,977,040`
  - median Enc(ms): `230.732`
- `strategy=2` with gate:
  - total HKN bytes: `2,975,171` (`-1,869 B`)
  - median Enc(ms): `363.941` (`+133.209 ms`)
  - `nat_mode2(ms)`: `96.793` (reduced from always-on `308.943`)

Interpretation:
- conditional gate cut the strategy2 overhead significantly
  (`496.291 -> 363.941`), while preserving most of the size gain.
- however, speed cost is still too high for default promotion.

### K-3: DP cost-model 2-pass trial (no-go, reverted)
- Tried replacing flat byte-cost with lazy1-histogram-derived cost table.
- CSV:
  - `bench_results/phase9w_max_lane_match_strategy2_dp_gate_costmodel_20260214_runs3.csv`
- Result:
  - size gain shrank (`-1,683 B` vs baseline)
  - median Enc regressed further (`359.208 ms` in that run)
- Decision:
  - reverted cost-model change; keep flat-cost DP for now.

Decision:
- Keep `optparse_dp` implementation as **max-lane experimental strategy** (`2`).
- Keep max-lane default at `strategy=1` (`lazy1`) for now.
- Do not route `balanced`/`fast` into DP path.
- Keep conditional-DP gate as current best strategy2 form.
- Next step is threshold sweep for gate params, not cost-model rewrite.

## Trial L: conditional-DP gate parameter sweep and tuned defaults
- Objective:
  - reduce strategy2 runtime cost while preserving some size gain.
- Tooling:
  - added `tools/sweep_optparse_gate.py` (runs=1 coarse sweep).
  - sweep dimensions:
    - `HKN_LZ_OPTPARSE_PROBE_RATIO_MAX`: `80,120`
    - `HKN_LZ_OPTPARSE_MIN_GAIN_BYTES`: `256,512,1024`
    - `HKN_LZ_OPTPARSE_MAX_MATCHES`: `1,2,4`
    - `HKN_LZ_OPTPARSE_LIT_MAX`: `32,64,128`
  - fixed:
    - `HKN_LZ_OPTPARSE_PROBE_SRC_MAX=2097152`
    - `HKN_LZ_OPTPARSE_PROBE_RATIO_MIN=20`
- Sweep outputs:
  - baseline: `bench_results/phase9w_optparse_gate_sweep_baseline_strategy1_runs1.csv`
  - summary: `bench_results/phase9w_optparse_gate_sweep_runs1_20260214.csv`
  - top list: `bench_results/phase9w_optparse_gate_sweep_top10_20260214.txt`

### Top-candidate rerun (runs=3)
- baseline:
  - `bench_results/phase9w_max_lane_match_strategy1_after_dp_gate_20260214_runs3.csv`
- candidate set:
  - `bench_results/phase9w_optparse_gate_top_c06_runs3_20260214.csv`
  - `bench_results/phase9w_optparse_gate_top_c12_runs3_20260214.csv`
  - `bench_results/phase9w_optparse_gate_top_c31_runs3_20260214.csv`
  - `bench_results/phase9w_optparse_gate_top_c37_runs3_20260214.csv`
  - `bench_results/phase9w_optparse_gate_top_c45_runs3_20260214.csv`
  - `bench_results/phase9w_optparse_gate_top_c46_runs3_20260214.csv`

Best tradeoff (runs=3):
- `ratio_max=120`, `min_gain=1024`, `opt_max_matches=1`, `opt_lit_max=32`
- result:
  - total bytes: `2,977,040 -> 2,976,086` (`-954 B`)
  - median Enc(ms): `230.732 -> 335.485` (`+104.753 ms`)

### Tuned strategy2 defaults applied
- `src/codec/lossless_natural_route.h`
  - `opt_max_matches`: `1`
  - `opt_lit_max`: `32`
  - `opt_min_gain_bytes`: `1024`

Validation (runs=3):
- CSV:
  - `bench_results/phase9w_max_lane_match_strategy2_dp_gate_tuned_default_20260214_runs3.csv`
- vs strategy1 baseline:
  - total bytes: `2,977,040 -> 2,976,086` (`-954 B`)
  - median Enc(ms): `230.732 -> 338.453` (`+107.721 ms`)

Decision:
- keep tuned strategy2 defaults above.
- strategy2 remains opt-in experimental (`HKN_MAX_LZ_MATCH_STRATEGY=2`).
