# Phase 9w Log (2026-02-14)

## Scope
- Continue single-core-first optimization after Step2 (`lossless_mode_select.h` LUT) promotion.
- Gate:
  - `total HKN bytes <= 2,977,544`
  - `median PNG/HKN >= 0.2610`
  - `ctest` 17/17 PASS
  - fixed6, `HAKONYANS_THREADS=1`, `taskset -c 0`, `runs=3`, `warmup=1`

## Baseline
- `bench_results/phase9w_singlecore_blockclass_step2_scalar_final_vs_afterfix_20260214_runs3.csv`
- key median:
  - `Enc(ms) 176.646`
  - `plane_route_comp(ms) 59.212`
  - `plane_lo_stream(ms) 58.312`

## Trial A: lo_stream mode3 branch-reduction rewrite (no-go)
- CSV:
  - `bench_results/phase9w_singlecore_lostream_mode3_branchcut_vs_step2_20260214_runs3.csv`
- result:
  - `Enc(ms) 176.646 -> 183.268` (regression)
  - size/ratio invariants unchanged
- archive:
  - `docs/archive/2026-02-14_lostream_mode3_branchcut_nogo.md`

## Trial B: byte_stream_encoder alloc/copy reduction (no-go)
- CSV:
  - `bench_results/phase9w_singlecore_bstream_allocopt_vs_step2_20260214_runs3.csv`
  - `bench_results/phase9w_singlecore_bstream_allocopt_vs_step2_20260214_runs3_rerun.csv`
- result:
  - wall encode not stable; no clear win across reruns
  - size/ratio invariants unchanged
- archive:
  - `docs/archive/2026-02-14_bstream_allocopt_nogo.md`

## Trial C: route_natural cost-loop fast-abs (no-go)
- CSV:
  - `bench_results/phase9w_singlecore_routecost_fastabs_vs_step2_20260214_runs3.csv`
- result:
  - `Enc(ms) 176.646 -> 187.400` (regression)
  - size/ratio invariants unchanged
- archive:
  - `docs/archive/2026-02-14_routecost_fastabs_nogo.md`

## Decision
- Reverted three no-go trial patches (A/B/C).
- Kept Trial D (`TileLZ::compress` low-level optimization) as current candidate.
- Preserved no-go history in `docs/archive/`.

## Trial D: TileLZ::compress low-level optimization (kept candidate)
- Target:
  - `src/codec/lz_tile.h`
- Changes:
  - hash-head initialization: per-call full init -> thread_local epoch table
  - literal flush: `insert(...)` -> `resize + memcpy`
  - match write: `push_back` chain -> contiguous fixed-size write
- Validation:
  - build + `ctest` 17/17 PASS
- CSV:
  - single-core:
    - `bench_results/phase9w_singlecore_tilelz_compress_fast_vs_step2_20260214_runs3.csv`
    - `bench_results/phase9w_singlecore_tilelz_compress_fast_vs_step2_20260214_runs3_rerun.csv`
    - `bench_results/phase9w_singlecore_tilelz_compress_fast_vs_step2_20260214_runs3_rerun2.csv`
    - `bench_results/phase9w_singlecore_tilelz_compress_fast_vs_step2_20260214_runs3_rerun3.csv`
  - multicore:
    - `bench_results/phase9w_tilelz_compress_fast_vs_step2_multi_20260214_runs3.csv`
    - `bench_results/phase9w_tilelz_compress_fast_vs_step2_multi_20260214_runs3_rerun.csv`
- Summary:
  - size invariants unchanged (`total=2,977,544`, `median PNG/HKN=0.261035`)
  - single-core `Enc(ms)`:
    - run1: `177.719` (regression)
    - run2: `174.960` (improvement)
    - run3: `175.056` (improvement)
    - run4: `175.765` (improvement)
  - decision: keep candidate (small but repeatable net gain)

## Trial E: `filter_lo` mode3/4 safe lower-bound skip + encode mode adoption counters (kept)
- Target:
  - `src/codec/lossless_filter_lo_codec.h`
  - `bench/bench_png_compare.cpp`
- Changes:
  - Added safe lower-bound reject for `mode3` and `mode4` in `encode_filter_lo_stream`.
    - reject when theoretical minimum wrapper size cannot beat `best_size`
    - reject when minimum size cannot pass wrapper gate (`990 permille`)
  - Added encode-side `filter_lo` mode adoption counters (`mode0..5`) to fixed6 CSV.
- Validation:
  - build + `ctest` 17/17 PASS
  - fixed6 single-core observation:
    - `bench_results/phase9w_singlecore_lostream_lbcut_obs_20260214_runs3.csv`
  - size gate:
    - `total HKN bytes = 2,977,544` (unchanged)
    - `median PNG/HKN = 0.2610` (unchanged)
- Mode adoption (per-image median, 3 planes):
  - `kodim01`: `mode5=3`
  - `kodim02`: `mode2=1`, `mode5=2`
  - `kodim03`: `mode0=1`, `mode1=2`
  - `hd_01`: `mode3=1`, `mode4=2`
  - `nature_01`: `mode0=2`, `mode4=1`
  - `nature_02`: `mode0=3`
- Decision:
  - keep lower-bound skip and CSV extension.
  - no static mode disable yet; each mode still appears in fixed6 adoption.

## Trial F: `route_natural mode2` nice-length cutoff
- Target:
  - `src/codec/lossless_natural_route.h`
  - `src/codec/lossless_mode_debug_stats.h`
  - `bench/bench_png_compare.cpp`
- Changes:
  - added `GlobalChainLzParams::nice_length` with env parser:
    - `HKN_LZ_NICE_LENGTH` (`4..255`)
  - added chain-loop early break when `best_len >= nice_length`
    (existing `best_len==255` break remains unchanged)
  - added telemetry:
    - `natural_row_mode2_lz_nice_cutoff_hits`
    - CSV: `hkn_enc_route_nat_mode2_lz_nice_cutoff_hits`

### Trial F-1: default `nice_length=64` (No-Go)
- CSV:
  - `bench_results/phase9w_singlecore_mode2_nice64_vs_lostreamlb_20260214_runs3.csv`
- Result:
  - size gate failed:
    - `kodim01`: `+6,907 B`
    - `hd_01`: `+237 B`
    - fixed6 total: `+7,144 B`
  - stage counters improved on hot path:
    - `chain_steps`: `3,530,143 -> 3,354,758`
    - `nice_cutoff_hits`: `5,044`
  - but non-worsening size rule is violated.
- archive:
  - `docs/archive/2026-02-14_mode2_nice64_nogo.md`

### Trial F-2: keep infra, set default `nice_length=255` (Kept)
- CSV:
  - `bench_results/phase9w_singlecore_mode2_nice255_vs_lostreamlb_20260214_runs3.csv`
- Result:
  - size gate restored:
    - `total HKN bytes = 2,977,544` (unchanged)
    - `median PNG/HKN = 0.2610` (unchanged)
  - `nice_cutoff_hits = 0` by default, so behavior is baseline-equivalent
    unless env override is used.
- Decision:
  - keep `nice_length` infrastructure + counters.
  - keep default at `255` for safety.
  - continue tuning via explicit env sweep only.

## Trial G: bind `nice_length` override to `fast` lane (Kept)
- Target:
  - `src/codec/encode.h`
  - `src/codec/lossless_natural_route.h`
- Changes:
  - `LosslessPresetPlan` now carries
    `natural_route_mode2_nice_length_override`.
  - `fast` preset sets this override from env:
    - `HKN_FAST_LZ_NICE_LENGTH` (default `64`, range `4..255`)
  - `balanced/max` keep `-1` (use global runtime default/path).
  - Natural route entry points now accept optional
    `mode2_nice_length_override` and apply it per encode call.
- Validation:
  - build + `ctest` 17/17 PASS
  - smoke:
    - `bench_results/phase9w_fast_lane_nice_binding_smoke_20260214_runs1.csv`
- Notes:
  - current policy keeps `fast` lane route competition OFF, so natural route
    is not entered in default `fast` operation (`nat_mode2_lz* == 0`).
  - binding is in place for lane coupling consistency and future opt-in
    fast-route experiments.
