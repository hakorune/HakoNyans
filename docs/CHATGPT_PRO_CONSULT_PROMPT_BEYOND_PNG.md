# ChatGPT Pro 相談文（Beyond PNG 最適化）

以下をそのまま ChatGPT Pro に渡してください。

---

HakoNyans の圧縮最適化について、実装可能なレベルでレビューと改善提案をお願いします。  
目的は **「PNG代替として論文投稿できる完成度」** まで仕上げることです。

## 1) プロジェクトの狙い
- 画像コーデック `HakoNyans`
- 強み: 並列デコード設計（NyANS-P, P-Index）、ロスレスの Copy/Palette/Filter、AAN IDCT
- 方針: 速度だけでなく、**圧縮率と画質**を実運用レベルまで引き上げる
- 投稿ターゲット: "Beyond PNG"（Lossless中心、Lossyも補助比較）

## 2) 現在の観測値（重要）
- Lossless:
  - UI/Anime は現状 PNG に劣後（HKN が約 3x〜4x 大きいケースが中心）
  - Photo は PNG より有利（HKN が約 0.7x、約 28% 小さい）
- Decode:
  - Photoカテゴリで重い（例: PNG 17.9ms vs HKN 45.4ms の観測）
- Lossy:
  - CfL の色バグは修正済み（再現MSEベース判定）
  - 画質回帰を避けつつサイズを詰める段階

## 3) 実装済みの主要要素
- Lossless:
  - YCoCg-R（可逆）
  - Filter 6種（None/Sub/Up/Avg/Paeth/MED）
  - Copy / Palette / Filter のモード選択（推定ビット最小化）
  - Tile Match 4x4（追加済み）
- Lossy:
  - 8x8 DCT + AAN IDCT
  - Chroma分離量子化
  - Band-group CDF
  - CfL（整数化 + 適応判定）

## 4) 制約（守ってほしい）
- 既存フォーマット互換は極力維持
- デコード速度の大幅悪化は不可（目安: +5%以内）
- まずは encoder-side 改善を優先
- 実装の複雑化で保守不能になる提案は避ける

## 5) 依頼したい出力（A〜Fで回答）

### A. 根本課題の整理（Lossless/Lossyを分離）
- LosslessでPNGに勝ち切れない主要因を、  
  `モード判定`, `予測残差`, `エントロピー符号`, `メタデータ`, `実装オーバーヘッド` に分解して説明
- Lossyでサイズが詰まり切らない主要因を、  
  `量子化`, `色予測`, `係数モデル`, `知覚最適化` で分解

### B. 優先度付き施策（P0/P1/P2）
- P0: 低リスク・即実装（1〜3日）
- P1: 中規模実装（1〜2週）
- P2: 論文向け差別化（2〜4週）
- 各施策について  
  `期待改善率`, `速度影響`, `実装難易度`, `回帰リスク`, `検証方法` を表で提示

### C. 具体アルゴリズム提案（擬似コード必須）
- Lossless:
  - Copy/Palette/Filter/TILE4 の最終選択式
  - Photo向けとUI向けで分岐する条件式（数値しきい値込み）
- Lossy:
  - CfL gate の改良案（誤適用防止）
  - Band-group/CDF文脈の追加案（軽量な範囲）
- すべて `現在の実装へ差し込み可能` な形で示すこと

### D. 実験計画（論文そのまま使える形式）
- データセット構成:
  - Anime / UI / Photo の3カテゴリ
  - 各カテゴリ最低30枚（可能なら50枚）
- 指標:
  - Lossless: `PNG_bytes/HKN_bytes`, `Enc(ms)`, `Dec(ms)`
  - Lossy: `PSNR`, `SSIM`, `MS-SSIM`, `bytes`, `Dec(ms)`
- 表と図:
  - 主要表 2枚、散布図 2枚、主観比較図 1枚
- アブレーション:
  - 何をON/OFFして比較するかを明記

### E. 論文の主張ライン（短文ドラフト）
- "Beyond PNG" としての主張を 3 本柱で提案
- 反論されやすい点（Photo遅い等）への回答テンプレートも提示

### F. 実装タスク化
- 最後に `そのまま Issue 化できる TODO` を 10〜15個、優先順で出力
- 各TODOに `対象ファイル候補`（例: `src/codec/encode.h`）を付ける

## 6) 出力フォーマット指定
- あいまい語（「状況による」「ケースバイケース」）を避ける
- しきい値は初期値を具体数値で出す
- 最後に「まず着手する3項目」を明記

---

必要なら、次の追加入力として bit accounting の実測ログと、失敗ケース画像の統計（U, CopyHit率, varY/varC）を渡します。  
まずは上記情報だけで、最も実行可能性が高い改善案をお願いします。
